<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Feedo - Home</title>
<style>
body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: radial-gradient(circle at top, #0a0f24, #000);
  color: white;
  overflow-x: hidden;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(0, 10, 40, 0.9);
  box-shadow: 0 0 20px rgba(0, 128, 255, 0.3);
  position: sticky;
  top: 0;
  z-index: 100;
}
.menu-icon {
  font-size: 24px;
  cursor: pointer;
  user-select: none;
}
.menu-box {
  position: absolute;
  top: 60px;
  left: 15px;
  background: rgba(10, 10, 20, 0.95);
  border-radius: 10px;
  padding: 10px 0;
  display: none;
  flex-direction: column;
  width: 200px;
  box-shadow: 0 0 12px rgba(0, 128, 255, 0.3);
  z-index: 200;
}
.menu-box a {
  color: white;
  text-decoration: none;
  padding: 10px 15px;
  display: block;
  transition: background 0.2s;
}
.menu-box a:hover {
  background: rgba(0, 128, 255, 0.2);
}
h1 {
  font-size: 24px;
  color: #00aaff;
  margin: 0;
}
.location {
  font-size: 14px;
  color: #ddd;
  max-width: 120px;
  text-align: right;
}
.categories {
  display: flex;
  overflow-x: auto;
  padding: 10px 15px;
  gap: 10px;
}
.category {
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(0, 128, 255, 0.3);
  border-radius: 20px;
  padding: 8px 15px;
  cursor: pointer;
  transition: 0.2s;
  white-space: nowrap;
  flex-shrink: 0;
}
.category.selected {
  background: #00aaff;
  color: white;
}
.shops {
  display: flex;
  flex-direction: column;
  padding: 15px;
  gap: 15px;
}
.shop-card {
  background: #111;
  border-radius: 14px;
  box-shadow: 0 0 15px rgba(0, 128, 255, 0.3);
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
.shop-card:hover {
  transform: scale(1.02);
  box-shadow: 0 0 25px rgba(0, 128, 255, 0.5);
}
.shop-card img {
  width: 100%;
  height: 180px;
  object-fit: cover;
}
.shop-info {
  padding: 10px;
  display: flex;
  flex-direction: column;
}
.shop-info h3 {
  margin: 0 0 5px 0;
}
.shop-info p {
  margin: 2px 0;
  color: #ccc;
}
.rating {
  color: gold;
  font-size: 14px;
}
.categories::-webkit-scrollbar {
  height: 6px;
}
.categories::-webkit-scrollbar-thumb {
  background: rgba(0, 128, 255, 0.5);
  border-radius: 3px;
}
</style>
</head>
<body>
<header>
  <div class="menu-icon" id="menuBtn">‚ò∞</div>
  <div class="menu-box" id="menuBox">
    <a href="#" id="profileBtn">Profile</a>
    <a href="#" id="offersBtn">Offers</a>
    <a href="#" id="ordersBtn">My Orders</a>
    <a href="#" id="loginLogoutBtn">Login</a>
  </div>
  <h1>Feedo</h1>
  <div class="location" id="location">üìç Detecting...</div>
</header>

<section class="categories" id="categorySection">
  <div class="category">Pizza</div>
  <div class="category">Burger</div>
  <div class="category">Cake</div>
  <div class="category">Sandwich</div>
  <div class="category">Cold Drinks</div>
</section>

<section class="shops" id="shopsSection">
  <p style="text-align:center; color:#777;">Loading shops...</p>
</section>

<script>
// Prevent back to login
history.pushState(null, null, location.href);
window.onpopstate = function () { history.go(1); };

// Menu toggle
const menuBtn = document.getElementById("menuBtn");
const menuBox = document.getElementById("menuBox");
menuBtn.addEventListener("click", () => {
  menuBox.style.display = menuBox.style.display === "flex" ? "none" : "flex";
  menuBox.style.flexDirection = "column";
});

// Detect location
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(async pos => {
    try{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
      const data = await res.json();
      const loc = data.address.city || data.address.town || data.address.village || "Unknown";
      document.getElementById("location").textContent = `üìç ${loc}, ${data.address.state || ""}`;
    } catch { document.getElementById("location").textContent = "üìç Location Unavailable"; }
  });
}

// Login/logout
const loggedIn = localStorage.getItem("loggedIn") === "true";
const loginLogoutBtn = document.getElementById("loginLogoutBtn");
if(loggedIn){ loginLogoutBtn.textContent = "Sign Out"; }
else{ loginLogoutBtn.textContent = "Login"; }

loginLogoutBtn.addEventListener("click", () => {
  if(loggedIn){ localStorage.clear(); window.location.reload(); }
  else{ window.location.href = "auth.html"; }
});

// Menu options
document.getElementById("profileBtn").addEventListener("click", () => {
  const name = localStorage.getItem("userName") || "Guest User";
  const phone = localStorage.getItem("userPhone") || "Not set";
  alert(`üë§ Name: ${name}\nüìû Phone: ${phone}`);
});
document.getElementById("offersBtn").addEventListener("click", () => { alert("üéÅ Offers coming soon!"); });
document.getElementById("ordersBtn").addEventListener("click", () => { window.location.href = "myorders.html"; });

// Categories selection
const categories = document.querySelectorAll(".category");

// Backend API base URL
const API_BASE = "https://chartpoint-backend.vercel.app
"; // Updated

// Add Mister Chef manually
const initialShops = [
  {
    name: "Mister Chef",
    rating: 4.8,
    imageUrl: "https://chartpoint-backend.vercel.app
/flypizza.jpg",
    description: "Delicious pizzas and sandwiches!",
    categories: ["Pizza","Sandwich"]
  }
];

// Fetch shops from backend
async function fetchShops(){
  try{
    const res = await fetch(`${API_BASE}/api/shops`);
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } 
    catch { console.error("Invalid JSON response:", text); data = []; }
    return data;
  }catch(err){
    console.error(err);
    return [];
  }
}

async function renderShops(){
  const shopsData = [...initialShops, ...(await fetchShops())]; // Merge manual + backend
  const selectedCategories = Array.from(categories).filter(cat => cat.classList.contains("selected")).map(c => c.textContent);
  const filtered = selectedCategories.length>0 ? shopsData.filter(shop => shop.categories && selectedCategories.some(c => shop.categories.includes(c))) : shopsData;

  const shopsSection = document.getElementById("shopsSection");
  shopsSection.innerHTML = "";
  if(filtered.length===0){ shopsSection.innerHTML = `<p style="text-align:center; color:#777;">No shops found</p>`; return; }

  filtered.forEach(shop => {
    const div = document.createElement("div");
    div.classList.add("shop-card");
    div.dataset.name = shop.name || "Unnamed";
    div.innerHTML = `
      <img src="${shop.imageUrl || 'https://via.placeholder.com/180'}" alt="${shop.name}">
      <div class="shop-info">
        <h3>${shop.name}</h3>
        <p>${shop.description || "No description available."}</p>
        <div class="rating">‚≠ê ${shop.rating || 4.5}</div>
      </div>
    `;
    div.addEventListener("click", () => {
      localStorage.setItem("shopName", shop.name);
      window.location.href = "shop.html";
    });
    shopsSection.appendChild(div);
  });
}

// Category selection
categories.forEach(cat => cat.addEventListener("click", () => { cat.classList.toggle("selected"); renderShops(); }));

renderShops();
</script>
</body>
</html>
